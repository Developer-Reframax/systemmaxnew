[{"filePath":"C:\\Users\\garibaldi.neto\\systemmaxnew\\src\\app\\api\\inspecoes\\formularios\\route.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\garibaldi.neto\\systemmaxnew\\src\\app\\layout.tsx","messages":[{"ruleId":"react-refresh/only-export-components","severity":1,"message":"Fast refresh only works when a file only exports components. Use a new file to share constants or functions between components.","line":10,"column":14,"nodeType":"Identifier","messageId":"namedExport","endLine":10,"endColumn":32}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import type { Metadata } from \"next\"\r\nimport { Inter } from \"next/font/google\"\r\nimport \"./globals.css\"\r\nimport { AuthProvider } from '@/contexts/AuthContext'\r\nimport { ThemeProvider } from '@/contexts/ThemeContext'\r\nimport { Toaster } from 'sonner'\r\n\r\nconst inter = Inter({ subsets: [\"latin\"] })\r\n\r\nexport const metadata: Metadata = {\r\n  title: \"Sistema de Gestão de Segurança do Trabalho\",\r\n  description: \"Sistema completo para gestão de segurança do trabalho\",\r\n}\r\n\r\nexport default function RootLayout({\r\n  children,\r\n}: Readonly<{\r\n  children: React.ReactNode\r\n}>) {\r\n  return (\r\n    <html lang=\"pt-BR\">\r\n      <body className={`${inter.className} antialiased`}>\r\n        <ThemeProvider>\r\n          <AuthProvider>\r\n            {children}\r\n            <Toaster richColors position=\"top-right\" />\r\n          </AuthProvider>\r\n        </ThemeProvider>\r\n      </body>\r\n    </html>\r\n  )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\garibaldi.neto\\systemmaxnew\\src\\app\\profile\\page.tsx","messages":[{"ruleId":"react-hooks/exhaustive-deps","severity":1,"message":"React Hook useEffect has a missing dependency: 'loadProfile'. Either include it or remove the dependency array.","line":40,"column":6,"nodeType":"ArrayExpression","endLine":40,"endColumn":12,"suggestions":[{"desc":"Update the dependencies array to be: [loadProfile, user]","fix":{"range":[1130,1136],"text":"[loadProfile, user]"}}]}],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":1,"fixableErrorCount":0,"fixableWarningCount":0,"source":"'use client'\r\n\r\nimport { useState, useEffect } from 'react'\r\nimport { useAuth } from '@/hooks/useAuth'\r\nimport MainLayout from '@/components/Layout/MainLayout'\r\n// Removed direct Supabase import - using API routes instead\r\nimport { User, Mail, Phone, MapPin, Calendar, Edit3, Save, X, Camera, Shield } from 'lucide-react'\r\nimport { toast } from 'sonner'\r\n\r\ninterface UserProfile {\r\n  nome: string\r\n  email: string\r\n  telefone: string\r\n  endereco: string\r\n  data_nascimento: string\r\n  bio: string\r\n  avatar_url?: string\r\n}\r\n\r\nexport default function ProfilePage() {\r\n  const { user } = useAuth()\r\n  const [profile, setProfile] = useState<UserProfile>({\r\n    nome: '',\r\n    email: '',\r\n    telefone: '',\r\n    endereco: '',\r\n    data_nascimento: '',\r\n    bio: ''\r\n  })\r\n  const [isEditing, setIsEditing] = useState(false)\r\n  const [loading, setLoading] = useState(true)\r\n  const [saving, setSaving] = useState(false)\r\n  const [avatarFile, setAvatarFile] = useState<File | null>(null)\r\n  const [avatarPreview, setAvatarPreview] = useState<string | null>(null)\r\n\r\n  useEffect(() => {\r\n    if (user) {\r\n      loadProfile()\r\n    }\r\n  }, [user])\r\n\r\n  const loadProfile = async () => {\r\n    if (!user) return\r\n    \r\n    try {\r\n      setLoading(true)\r\n      \r\n      const token = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null\r\n      if (!token) {\r\n        toast.error('Token de autenticação não encontrado')\r\n        return\r\n      }\r\n      \r\n      const response = await fetch(`/api/users/${user.matricula}`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': `Bearer ${token}`,\r\n          'Content-Type': 'application/json'\r\n        }\r\n      })\r\n      \r\n      if (!response.ok) {\r\n        throw new Error('Erro ao carregar perfil')\r\n      }\r\n      \r\n      const data = await response.json()\r\n      \r\n      setProfile({\r\n        nome: data.nome || '',\r\n        email: data.email || '',\r\n        telefone: data.telefone || '',\r\n        endereco: data.endereco || '',\r\n        data_nascimento: data.data_nascimento || '',\r\n        bio: data.bio || ''\r\n      })\r\n      \r\n      if (data.avatar_url) {\r\n        setAvatarPreview(data.avatar_url)\r\n      }\r\n    } catch (error) {\r\n      console.error('Erro ao carregar perfil:', error)\r\n      toast.error('Erro ao carregar perfil')\r\n    } finally {\r\n      setLoading(false)\r\n    }\r\n  }\r\n\r\n  const handleAvatarChange = (e: React.ChangeEvent<HTMLInputElement>) => {\r\n    const file = e.target.files?.[0]\r\n    if (file) {\r\n      if (file.size > 5 * 1024 * 1024) { // 5MB limit\r\n        toast.error('A imagem deve ter no máximo 5MB')\r\n        return\r\n      }\r\n      \r\n      if (!file.type.startsWith('image/')) {\r\n        toast.error('Por favor, selecione uma imagem válida')\r\n        return\r\n      }\r\n      \r\n      setAvatarFile(file)\r\n      \r\n      // Create preview\r\n      const reader = new FileReader()\r\n      reader.onload = (e) => {\r\n        setAvatarPreview(e.target?.result as string)\r\n      }\r\n      reader.readAsDataURL(file)\r\n    }\r\n  }\r\n\r\n  const uploadAvatar = async (): Promise<string | null> => {\r\n    if (!avatarFile || !user) return null\r\n    \r\n    try {\r\n      const token = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null\r\n      if (!token) {\r\n        toast.error('Token de autenticação não encontrado')\r\n        return null\r\n      }\r\n      \r\n      const formData = new FormData()\r\n      formData.append('avatar', avatarFile)\r\n      formData.append('matricula', user.matricula.toString())\r\n      \r\n      const response = await fetch('/api/users/avatar', {\r\n        method: 'POST',\r\n        headers: {\r\n          'Authorization': `Bearer ${token}`\r\n        },\r\n        body: formData\r\n      })\r\n      \r\n      if (!response.ok) {\r\n        throw new Error('Erro ao fazer upload do avatar')\r\n      }\r\n      \r\n      const data = await response.json()\r\n      return data.avatar_url\r\n    } catch (error) {\r\n      console.error('Erro ao fazer upload do avatar:', error)\r\n      toast.error('Erro ao fazer upload da imagem')\r\n      return null\r\n    }\r\n  }\r\n\r\n  const saveProfile = async () => {\r\n    if (!user) return\r\n    \r\n    try {\r\n      setSaving(true)\r\n      \r\n      const token = typeof window !== 'undefined' ? localStorage.getItem('auth_token') : null\r\n      if (!token) {\r\n        toast.error('Token de autenticação não encontrado')\r\n        return\r\n      }\r\n      \r\n      let avatarUrl = profile.avatar_url\r\n      \r\n      // Upload new avatar if selected\r\n      if (avatarFile) {\r\n        const uploadedUrl = await uploadAvatar()\r\n        if (uploadedUrl) {\r\n          avatarUrl = uploadedUrl\r\n        }\r\n      }\r\n      \r\n      const response = await fetch(`/api/users/${user.matricula}`, {\r\n        method: 'PUT',\r\n        headers: {\r\n          'Authorization': `Bearer ${token}`,\r\n          'Content-Type': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          nome: profile.nome,\r\n          telefone: profile.telefone,\r\n          endereco: profile.endereco,\r\n          data_nascimento: profile.data_nascimento,\r\n          bio: profile.bio,\r\n          avatar_url: avatarUrl\r\n        })\r\n      })\r\n      \r\n      if (!response.ok) {\r\n        throw new Error('Erro ao salvar perfil')\r\n      }\r\n      \r\n      // Profile updated successfully\r\n      setIsEditing(false)\r\n      setAvatarFile(null)\r\n      toast.success('Perfil atualizado com sucesso!')\r\n    } catch (error) {\r\n      console.error('Erro ao salvar perfil:', error)\r\n      toast.error('Erro ao salvar perfil')\r\n    } finally {\r\n      setSaving(false)\r\n    }\r\n  }\r\n\r\n  const cancelEdit = () => {\r\n    setIsEditing(false)\r\n    setAvatarFile(null)\r\n    setAvatarPreview(profile.avatar_url || null)\r\n    loadProfile() // Reload original data\r\n  }\r\n\r\n  const formatDate = (dateString: string) => {\r\n    if (!dateString) return 'Não informado'\r\n    return new Date(dateString).toLocaleDateString('pt-BR')\r\n  }\r\n\r\n  const calculateAge = (birthDate: string) => {\r\n    if (!birthDate) return null\r\n    const today = new Date()\r\n    const birth = new Date(birthDate)\r\n    let age = today.getFullYear() - birth.getFullYear()\r\n    const monthDiff = today.getMonth() - birth.getMonth()\r\n    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birth.getDate())) {\r\n      age--\r\n    }\r\n    return age\r\n  }\r\n\r\n  if (loading) {\r\n    return (\r\n      <MainLayout>\r\n        <div className=\"flex justify-center items-center h-64\">\r\n          <div className=\"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600\"></div>\r\n        </div>\r\n      </MainLayout>\r\n    )\r\n  }\r\n\r\n  return (\r\n    <MainLayout>\r\n      <div className=\"space-y-6\">\r\n        <div className=\"flex justify-between items-center\">\r\n          <h1 className=\"text-2xl font-bold text-gray-900 dark:text-white\">Meu Perfil</h1>\r\n          {!isEditing ? (\r\n            <button\r\n              onClick={() => setIsEditing(true)}\r\n              className=\"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500\"\r\n            >\r\n              <Edit3 className=\"h-4 w-4 mr-2\" />\r\n              Editar Perfil\r\n            </button>\r\n          ) : (\r\n            <div className=\"flex space-x-2\">\r\n              <button\r\n                onClick={saveProfile}\r\n                disabled={saving}\r\n                className=\"inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-green-600 hover:bg-green-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-green-500 disabled:opacity-50\"\r\n              >\r\n                {saving ? (\r\n                  <div className=\"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2\"></div>\r\n                ) : (\r\n                  <Save className=\"h-4 w-4 mr-2\" />\r\n                )}\r\n                Salvar\r\n              </button>\r\n              <button\r\n                onClick={cancelEdit}\r\n                disabled={saving}\r\n                className=\"inline-flex items-center px-4 py-2 border border-gray-300 dark:border-gray-600 text-sm font-medium rounded-md text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 disabled:opacity-50\"\r\n              >\r\n                <X className=\"h-4 w-4 mr-2\" />\r\n                Cancelar\r\n              </button>\r\n            </div>\r\n          )}\r\n        </div>\r\n\r\n        <div className=\"bg-white dark:bg-gray-800 shadow-md rounded-lg overflow-hidden\">\r\n          {/* Header with Avatar */}\r\n          <div className=\"bg-gradient-to-r from-blue-500 to-blue-600 px-6 py-8\">\r\n            <div className=\"flex items-center space-x-6\">\r\n              <div className=\"relative\">\r\n                <div className=\"w-24 h-24 rounded-full bg-white dark:bg-gray-700 flex items-center justify-center overflow-hidden\">\r\n                  {avatarPreview ? (\r\n                    <img\r\n                      src={avatarPreview}\r\n                      alt=\"Avatar\"\r\n                      className=\"w-full h-full object-cover\"\r\n                    />\r\n                  ) : (\r\n                    <User className=\"h-12 w-12 text-gray-400\" />\r\n                  )}\r\n                </div>\r\n                {isEditing && (\r\n                  <label className=\"absolute bottom-0 right-0 bg-blue-600 hover:bg-blue-700 text-white rounded-full p-2 cursor-pointer shadow-lg transition-colors\">\r\n                    <Camera className=\"h-4 w-4\" />\r\n                    <input\r\n                      type=\"file\"\r\n                      accept=\"image/*\"\r\n                      onChange={handleAvatarChange}\r\n                      className=\"hidden\"\r\n                    />\r\n                  </label>\r\n                )}\r\n              </div>\r\n              <div className=\"text-white\">\r\n                <h2 className=\"text-2xl font-bold\">{profile.nome || 'Nome não informado'}</h2>\r\n                <p className=\"text-blue-100\">{profile.email}</p>\r\n                <div className=\"flex items-center mt-2\">\r\n                  <Shield className=\"h-4 w-4 mr-1\" />\r\n                  <span className=\"text-sm\">\r\n                    {user?.role === 'Admin' ? 'Administrador' : user?.role === 'Editor' ? 'Editor' : 'Usuário'}\r\n                  </span>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n\r\n          {/* Profile Information */}\r\n          <div className=\"p-6\">\r\n            <div className=\"grid grid-cols-1 md:grid-cols-2 gap-6\">\r\n              {/* Personal Information */}\r\n              <div className=\"space-y-4\">\r\n                <h3 className=\"text-lg font-medium text-gray-900 dark:text-white mb-4\">Informações Pessoais</h3>\r\n                \r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\r\n                    <User className=\"inline h-4 w-4 mr-1\" />\r\n                    Nome Completo\r\n                  </label>\r\n                  {isEditing ? (\r\n                    <input\r\n                      type=\"text\"\r\n                      value={profile.nome}\r\n                      onChange={(e) => setProfile(prev => ({ ...prev, nome: e.target.value }))}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\r\n                      placeholder=\"Digite seu nome completo\"\r\n                    />\r\n                  ) : (\r\n                    <p className=\"text-gray-900 dark:text-white\">{profile.nome || 'Não informado'}</p>\r\n                  )}\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\r\n                    <Mail className=\"inline h-4 w-4 mr-1\" />\r\n                    Email\r\n                  </label>\r\n                  <p className=\"text-gray-900 dark:text-white bg-gray-50 dark:bg-gray-700 px-3 py-2 rounded-lg\">\r\n                    {profile.email || 'Não informado'}\r\n                  </p>\r\n                  <p className=\"text-xs text-gray-500 dark:text-gray-400 mt-1\">\r\n                    O email não pode ser alterado pelo usuário\r\n                  </p>\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\r\n                    <Phone className=\"inline h-4 w-4 mr-1\" />\r\n                    Telefone\r\n                  </label>\r\n                  {isEditing ? (\r\n                    <input\r\n                      type=\"tel\"\r\n                      value={profile.telefone}\r\n                      onChange={(e) => setProfile(prev => ({ ...prev, telefone: e.target.value }))}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\r\n                      placeholder=\"(11) 99999-9999\"\r\n                    />\r\n                  ) : (\r\n                    <p className=\"text-gray-900 dark:text-white\">{profile.telefone || 'Não informado'}</p>\r\n                  )}\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\r\n                    <Calendar className=\"inline h-4 w-4 mr-1\" />\r\n                    Data de Nascimento\r\n                  </label>\r\n                  {isEditing ? (\r\n                    <input\r\n                      type=\"date\"\r\n                      value={profile.data_nascimento}\r\n                      onChange={(e) => setProfile(prev => ({ ...prev, data_nascimento: e.target.value }))}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\r\n                    />\r\n                  ) : (\r\n                    <div>\r\n                      <p className=\"text-gray-900 dark:text-white\">{formatDate(profile.data_nascimento)}</p>\r\n                      {profile.data_nascimento && (\r\n                        <p className=\"text-sm text-gray-500 dark:text-gray-400\">\r\n                          {calculateAge(profile.data_nascimento)} anos\r\n                        </p>\r\n                      )}\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {/* Additional Information */}\r\n              <div className=\"space-y-4\">\r\n                <h3 className=\"text-lg font-medium text-gray-900 dark:text-white mb-4\">Informações Adicionais</h3>\r\n                \r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\r\n                    <MapPin className=\"inline h-4 w-4 mr-1\" />\r\n                    Endereço\r\n                  </label>\r\n                  {isEditing ? (\r\n                    <textarea\r\n                      value={profile.endereco}\r\n                      onChange={(e) => setProfile(prev => ({ ...prev, endereco: e.target.value }))}\r\n                      rows={3}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\r\n                      placeholder=\"Digite seu endereço completo\"\r\n                    />\r\n                  ) : (\r\n                    <p className=\"text-gray-900 dark:text-white whitespace-pre-wrap\">\r\n                      {profile.endereco || 'Não informado'}\r\n                    </p>\r\n                  )}\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2\">\r\n                    Biografia\r\n                  </label>\r\n                  {isEditing ? (\r\n                    <textarea\r\n                      value={profile.bio}\r\n                      onChange={(e) => setProfile(prev => ({ ...prev, bio: e.target.value }))}\r\n                      rows={4}\r\n                      className=\"w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white dark:bg-gray-700 text-gray-900 dark:text-white\"\r\n                      placeholder=\"Conte um pouco sobre você...\"\r\n                      maxLength={500}\r\n                    />\r\n                  ) : (\r\n                    <p className=\"text-gray-900 dark:text-white whitespace-pre-wrap\">\r\n                      {profile.bio || 'Nenhuma biografia adicionada'}\r\n                    </p>\r\n                  )}\r\n                  {isEditing && (\r\n                    <p className=\"text-xs text-gray-500 dark:text-gray-400 mt-1\">\r\n                      {profile.bio.length}/500 caracteres\r\n                    </p>\r\n                  )}\r\n                </div>\r\n\r\n                {/* Account Information */}\r\n                <div className=\"bg-gray-50 dark:bg-gray-700 rounded-lg p-4\">\r\n                  <h4 className=\"text-sm font-medium text-gray-900 dark:text-white mb-2\">Informações da Conta</h4>\r\n                  <div className=\"text-sm text-gray-600 dark:text-gray-400 space-y-1\">\r\n                    <p>Matrícula: {user?.matricula}</p>\r\n                    <p>Membro desde: Não disponível</p>\r\n                    <p>Último acesso: Não disponível</p>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </MainLayout>\r\n  )\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\garibaldi.neto\\systemmaxnew\\src\\lib\\services\\alertas.ts","messages":[{"ruleId":"@typescript-eslint/no-unused-vars","severity":2,"message":"'usuario_matricula' is defined but never used.","line":176,"column":3,"nodeType":null,"messageId":"unusedVar","endLine":176,"endColumn":20}],"suppressedMessages":[],"errorCount":1,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"source":"import { supabase } from '@/lib/supabase'\r\n\r\nexport interface AlertaEmociograma {\r\n  id: string\r\n  usuario_matricula: number\r\n  usuario_nome: string\r\n  equipe?: string\r\n  letra?: string\r\n  estado_emocional: 'regular' | 'pessimo'\r\n  observacoes?: string\r\n  data_registro: string\r\n  lider_matricula?: number\r\n  supervisor_matricula?: number\r\n  notificado: boolean\r\n  created_at: string\r\n}\r\n\r\nexport interface NotificacaoAlerta {\r\n  destinatario_matricula: number\r\n  destinatario_nome: string\r\n  destinatario_email?: string\r\n  tipo: 'lider' | 'supervisor'\r\n  usuario_afetado: string\r\n  estado_emocional: string\r\n  data_registro: string\r\n  observacoes?: string\r\n}\r\n\r\n/**\r\n * Cria alertas automáticos para estados emocionais irregulares\r\n */\r\nexport async function criarAlertaEmociograma(\r\n  usuarioMatricula: number,\r\n  estadoEmocional: 'regular' | 'pessimo',\r\n  observacoes?: string\r\n): Promise<void> {\r\n  try {\r\n    // Buscar informações do usuário com suas relações\r\n    const { data: usuario, error: userError } = await supabase\r\n      .from('usuarios')\r\n      .select(`\r\n        nome,\r\n        letra_id,\r\n        equipe_id,\r\n        letras!usuarios_letra_id_fkey(letra),\r\n        equipes!usuarios_equipe_id_fkey(equipe)\r\n      `)\r\n      .eq('matricula', usuarioMatricula)\r\n      .single()\r\n\r\n    if (userError || !usuario) {\r\n      console.error('Erro ao buscar usuário para alerta:', userError)\r\n      return\r\n    }\r\n\r\n    const equipe = usuario.equipes?.[0]?.equipe\r\n    const letra = usuario.letras?.[0]?.letra\r\n\r\n    // Buscar líderes e supervisores responsáveis\r\n    const responsaveis = await buscarResponsaveis(equipe, letra)\r\n\r\n    // Criar registro de alerta\r\n    const { error: alertError } = await supabase\r\n      .from('alertas_emociograma')\r\n      .insert({\r\n        usuario_matricula: usuarioMatricula,\r\n        usuario_nome: usuario.nome,\r\n        equipe: equipe,\r\n        letra: letra,\r\n        estado_emocional: estadoEmocional,\r\n        observacoes,\r\n        data_registro: new Date().toISOString(),\r\n        lider_matricula: responsaveis.lider?.matricula,\r\n        supervisor_matricula: responsaveis.supervisor?.matricula,\r\n        notificado: false\r\n      })\r\n\r\n    if (alertError) {\r\n      console.error('Erro ao criar alerta:', alertError)\r\n      return\r\n    }\r\n\r\n    // Enviar notificações\r\n    await enviarNotificacoes({\r\n      usuario_afetado: usuario.nome,\r\n      usuario_matricula: usuarioMatricula,\r\n      estado_emocional: estadoEmocional,\r\n      observacoes,\r\n      responsaveis\r\n    })\r\n\r\n  } catch (error) {\r\n    console.error('Erro ao processar alerta de emociograma:', error)\r\n  }\r\n}\r\n\r\n/**\r\n * Busca líderes e supervisores responsáveis pela equipe/letra do usuário\r\n */\r\nasync function buscarResponsaveis(equipe?: string, letra?: string) {\r\n  const responsaveis: {\r\n    lider?: { matricula: number; nome: string; email?: string }\r\n    supervisor?: { matricula: number; nome: string; email?: string }\r\n  } = {}\r\n\r\n  try {\r\n    // Buscar líder da letra (se houver)\r\n    if (letra) {\r\n      const { data: lider } = await supabase\r\n        .from('letras')\r\n        .select(`\r\n          lider,\r\n          usuarios!letras_lider_fkey(matricula, nome, email)\r\n        `)\r\n        .eq('letra', letra)\r\n        .not('lider', 'is', null)\r\n        .single()\r\n\r\n      if (lider?.usuarios?.[0]) {\r\n        responsaveis.lider = {\r\n          matricula: lider.usuarios[0].matricula,\r\n          nome: lider.usuarios[0].nome,\r\n          email: lider.usuarios[0].email\r\n        }\r\n      }\r\n    }\r\n\r\n    // Buscar supervisor da equipe (se houver)\r\n    if (equipe) {\r\n      const { data: supervisor } = await supabase\r\n        .from('equipes')\r\n        .select(`\r\n          supervisor,\r\n          usuarios!equipes_supervisor_fkey(matricula, nome, email)\r\n        `)\r\n        .eq('equipe', equipe)\r\n        .not('supervisor', 'is', null)\r\n        .single()\r\n\r\n      if (supervisor?.usuarios?.[0]) {\r\n        responsaveis.supervisor = {\r\n          matricula: supervisor.usuarios[0].matricula,\r\n          nome: supervisor.usuarios[0].nome,\r\n          email: supervisor.usuarios[0].email\r\n        }\r\n      }\r\n    }\r\n\r\n    // Se não encontrou líder específico, buscar por função geral\r\n    if (!responsaveis.lider) {\r\n      const { data: liderGeral } = await supabase\r\n        .from('usuarios')\r\n        .select('matricula, nome, email')\r\n        .or(`role.eq.Admin,role.eq.Editor`)\r\n        .eq('status', 'ativo')\r\n        .limit(1)\r\n        .single()\r\n\r\n      if (liderGeral) {\r\n        responsaveis.lider = liderGeral\r\n      }\r\n    }\r\n\r\n  } catch (error) {\r\n    console.error('Erro ao buscar responsáveis:', error)\r\n  }\r\n\r\n  return responsaveis\r\n}\r\n\r\n/**\r\n * Envia notificações para os responsáveis\r\n */\r\nasync function enviarNotificacoes({\r\n  usuario_afetado,\r\n  usuario_matricula,\r\n  estado_emocional,\r\n  observacoes,\r\n  responsaveis\r\n}: {\r\n  usuario_afetado: string\r\n  usuario_matricula: number\r\n  estado_emocional: string\r\n  observacoes?: string\r\n  responsaveis: {\r\n    lider?: { matricula: number; nome: string; email?: string }\r\n    supervisor?: { matricula: number; nome: string; email?: string }\r\n  }\r\n}) {\r\n  const notificacoes: NotificacaoAlerta[] = []\r\n\r\n  // Preparar notificação para líder\r\n  if (responsaveis.lider) {\r\n    notificacoes.push({\r\n      destinatario_matricula: responsaveis.lider.matricula,\r\n      destinatario_nome: responsaveis.lider.nome,\r\n      destinatario_email: responsaveis.lider.email,\r\n      tipo: 'lider',\r\n      usuario_afetado,\r\n      estado_emocional,\r\n      data_registro: new Date().toISOString(),\r\n      observacoes\r\n    })\r\n  }\r\n\r\n  // Preparar notificação para supervisor\r\n  if (responsaveis.supervisor && responsaveis.supervisor.matricula !== responsaveis.lider?.matricula) {\r\n    notificacoes.push({\r\n      destinatario_matricula: responsaveis.supervisor.matricula,\r\n      destinatario_nome: responsaveis.supervisor.nome,\r\n      destinatario_email: responsaveis.supervisor.email,\r\n      tipo: 'supervisor',\r\n      usuario_afetado,\r\n      estado_emocional,\r\n      data_registro: new Date().toISOString(),\r\n      observacoes\r\n    })\r\n  }\r\n\r\n  // Processar notificações\r\n  for (const notificacao of notificacoes) {\r\n    await processarNotificacao(notificacao)\r\n  }\r\n}\r\n\r\n/**\r\n * Processa uma notificação individual\r\n */\r\nasync function processarNotificacao(notificacao: NotificacaoAlerta) {\r\n  try {\r\n    // Registrar notificação no banco\r\n    const { error } = await supabase\r\n      .from('notificacoes_emociograma')\r\n      .insert({\r\n        destinatario_matricula: notificacao.destinatario_matricula,\r\n        tipo: notificacao.tipo,\r\n        usuario_afetado: notificacao.usuario_afetado,\r\n        estado_emocional: notificacao.estado_emocional,\r\n        data_registro: notificacao.data_registro,\r\n        observacoes: notificacao.observacoes,\r\n        lida: false,\r\n        created_at: new Date().toISOString()\r\n      })\r\n\r\n    if (error) {\r\n      console.error('Erro ao registrar notificação:', error)\r\n    }\r\n\r\n    // Aqui você pode implementar outros canais de notificação:\r\n    // - Email\r\n    // - SMS\r\n    // - Push notifications\r\n    // - Integração com Teams/Slack\r\n    \r\n    console.log(`Notificação enviada para ${notificacao.destinatario_nome} (${notificacao.tipo})`)\r\n\r\n  } catch (error) {\r\n    console.error('Erro ao processar notificação:', error)\r\n  }\r\n}\r\n\r\n/**\r\n * Busca alertas ativos para um usuário específico\r\n */\r\nexport async function buscarAlertasAtivos(usuarioMatricula?: number): Promise<AlertaEmociograma[]> {\r\n  try {\r\n    let query = supabase\r\n      .from('alertas_emociograma')\r\n      .select('*')\r\n      .eq('notificado', true)\r\n      .order('created_at', { ascending: false })\r\n\r\n    if (usuarioMatricula) {\r\n      query = query.eq('usuario_matricula', usuarioMatricula)\r\n    }\r\n\r\n    const { data, error } = await query\r\n\r\n    if (error) {\r\n      console.error('Erro ao buscar alertas:', error)\r\n      return []\r\n    }\r\n\r\n    return data || []\r\n  } catch (error) {\r\n    console.error('Erro ao buscar alertas ativos:', error)\r\n    return []\r\n  }\r\n}\r\n\r\n/**\r\n * Marca alertas como resolvidos\r\n */\r\nexport async function resolverAlerta(alertaId: string): Promise<boolean> {\r\n  try {\r\n    const { error } = await supabase\r\n      .from('alertas_emociograma')\r\n      .update({ resolvido: true, data_resolucao: new Date().toISOString() })\r\n      .eq('id', alertaId)\r\n\r\n    if (error) {\r\n      console.error('Erro ao resolver alerta:', error)\r\n      return false\r\n    }\r\n\r\n    return true\r\n  } catch (error) {\r\n    console.error('Erro ao resolver alerta:', error)\r\n    return false\r\n  }\r\n}\r\n\r\n/**\r\n * Valida hierarquia organizacional para tratativas\r\n */\r\nexport async function validarHierarquiaParaTratativa(\r\n  usuarioSolicitante: number,\r\n  usuarioAlvo: number\r\n): Promise<{ autorizado: boolean; motivo?: string }> {\r\n  try {\r\n    // Buscar informações dos usuários com suas relações\r\n    const [solicitante, alvo] = await Promise.all([\r\n      supabase.from('usuarios').select(`\r\n        *,\r\n        letras!usuarios_letra_id_fkey(letra),\r\n        equipes!usuarios_equipe_id_fkey(equipe)\r\n      `).eq('matricula', usuarioSolicitante).single(),\r\n      supabase.from('usuarios').select(`\r\n        *,\r\n        letras!usuarios_letra_id_fkey(letra),\r\n        equipes!usuarios_equipe_id_fkey(equipe)\r\n      `).eq('matricula', usuarioAlvo).single()\r\n    ])\r\n\r\n    if (!solicitante.data || !alvo.data) {\r\n      return { autorizado: false, motivo: 'Usuário não encontrado' }\r\n    }\r\n\r\n    // Admin e Editor podem gerenciar qualquer tratativa\r\n    if (['Admin', 'Editor'].includes(solicitante.data.role)) {\r\n      return { autorizado: true }\r\n    }\r\n\r\n    // Líder pode gerenciar tratativas da sua letra\r\n    if (solicitante.data.funcao?.includes('Líder')) {\r\n      const solicitanteLetra = solicitante.data.letras?.letra\r\n      const alvoLetra = alvo.data.letras?.letra\r\n      \r\n      if (solicitanteLetra && solicitanteLetra === alvoLetra) {\r\n        return { autorizado: true }\r\n      }\r\n      return { autorizado: false, motivo: 'Líder só pode gerenciar tratativas da sua letra' }\r\n    }\r\n\r\n    // Supervisor pode gerenciar tratativas da sua equipe\r\n    if (solicitante.data.funcao?.includes('Supervisor')) {\r\n      const solicitanteEquipe = solicitante.data.equipes?.equipe\r\n      const alvoEquipe = alvo.data.equipes?.equipe\r\n      \r\n      if (solicitanteEquipe && solicitanteEquipe === alvoEquipe) {\r\n        return { autorizado: true }\r\n      }\r\n      return { autorizado: false, motivo: 'Supervisor só pode gerenciar tratativas da sua equipe' }\r\n    }\r\n\r\n    return { autorizado: false, motivo: 'Usuário não possui permissão para gerenciar tratativas' }\r\n\r\n  } catch (error) {\r\n    console.error('Erro ao validar hierarquia:', error)\r\n    return { autorizado: false, motivo: 'Erro interno do sistema' }\r\n  }\r\n}\r\n\r\n/**\r\n * Busca estatísticas de alertas para dashboard\r\n */\r\nexport async function buscarEstatisticasAlertas(periodo: '7d' | '30d' | '90d' = '30d') {\r\n  try {\r\n    const dataInicio = new Date()\r\n    const dias = periodo === '7d' ? 7 : periodo === '30d' ? 30 : 90\r\n    dataInicio.setDate(dataInicio.getDate() - dias)\r\n\r\n    const { data, error } = await supabase\r\n      .from('alertas_emociograma')\r\n      .select('estado_emocional, created_at, resolvido')\r\n      .gte('created_at', dataInicio.toISOString())\r\n\r\n    if (error) {\r\n      console.error('Erro ao buscar estatísticas de alertas:', error)\r\n      return {\r\n        totalAlertas: 0,\r\n        alertasRegular: 0,\r\n        alertasPessimo: 0,\r\n        alertasResolvidos: 0,\r\n        alertasPendentes: 0\r\n      }\r\n    }\r\n\r\n    const stats = {\r\n      totalAlertas: data.length,\r\n      alertasRegular: data.filter(a => a.estado_emocional === 'regular').length,\r\n      alertasPessimo: data.filter(a => a.estado_emocional === 'pessimo').length,\r\n      alertasResolvidos: data.filter(a => a.resolvido).length,\r\n      alertasPendentes: data.filter(a => !a.resolvido).length\r\n    }\r\n\r\n    return stats\r\n  } catch (error) {\r\n    console.error('Erro ao buscar estatísticas de alertas:', error)\r\n    return {\r\n      totalAlertas: 0,\r\n      alertasRegular: 0,\r\n      alertasPessimo: 0,\r\n      alertasResolvidos: 0,\r\n      alertasPendentes: 0\r\n    }\r\n  }\r\n}\r\n","usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]},{"filePath":"C:\\Users\\garibaldi.neto\\systemmaxnew\\src\\lib\\services\\pdfService.ts","messages":[],"suppressedMessages":[],"errorCount":0,"fatalErrorCount":0,"warningCount":0,"fixableErrorCount":0,"fixableWarningCount":0,"usedDeprecatedRules":[{"ruleId":"no-extra-semi","replacedBy":[]},{"ruleId":"no-mixed-spaces-and-tabs","replacedBy":[]}]}]